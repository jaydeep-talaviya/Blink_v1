{% extends '../../base.html' %}
{% load static %}
{% block title %}Home{% endblock title %}
{% block main-content %}
<div class="my-5">
  {%include '../partials/breadcrumbs.html'%}
</div>
{%load crispy_forms_tags %} 

<div class="container mb-5">

            {% load crispy_forms_tags %}
            <div class="d-sm-flex align-items-center justify-content-center mb-4">
              {% if pid %}
              <h1 class="h3 mb-0 text-gray-800">Update {{forms.p_name.value}}</h1>

              {% else %}
              <h1 class="h3 mb-0 text-gray-800">Add New Product</h1>
              {% endif %}
            </div>
            <div class="d-flex justify-content-center pb-2">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group col-md-4 mb-0">
                          {{ forms.p_name|as_crispy_field }}
                        </div>

                        <div class="form-group col-md-4 mb-0">
                          {{ forms.p_category|as_crispy_field }}
                        </div>
                        <div class="form-group col-md-4 mb-0">
                          {{ forms.p_subcategory|as_crispy_field }}
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-12 mb-0">
                          {{ forms.description|as_crispy_field }}
                        </div>
                      </div>

                      <div class="form-row">
                        <div class="form-group col-md-4 mb-0">
                          {{ forms.price|as_crispy_field }}

                        </div>
                      </div>
                      <div class="form-row" style="overflow-wrap: break-word;">
                        <div class="form-group col-md-4 mb-0">
                          {{ forms.photo_1|as_crispy_field }}
                            <div style="width: 200px; height: 200px; border:1px solid;display: none;">
                                <img id="image-preview-1" src="#" alt="Image Preview" style="max-width: 200px; height: 100%;display: none;">
                            </div>
                        </div>
                        <div class="form-group col-md-4 mb-0">
                            {{ forms.photo_2|as_crispy_field }}
                            <div style="width: 200px; height: 200px; border:1px solid;display: none;">
                             <img id="image-preview-2" src="#" alt="Image Preview" style="max-width: 200px; height: 100%;display: none;">
                            </div>
                          </div>
                          <div class="form-group col-md-4 mb-0">
                            {{ forms.photo_3|as_crispy_field }}
                              <div style="width: 200px; height: 200px; border:1px solid;display: none;">
                                <img id="image-preview-3" src="#" alt="Image Preview" style="max-width: 200px; height: 100%;display: none;">
                              </div>
                          </div>
                      </div>
                      <div class="form-row" style="overflow-wrap: break-word;">
                        <div class="form-group col-md-4 mb-0">
                          {{ forms.photo_4|as_crispy_field }}
                            <div style="width: 200px; height: 200px; border:1px solid;display: none;">
                          <img id="image-preview-4" src="#" alt="Image Preview" style="max-width: 200px; height: 100%;display: none;">
                        </div>
                        </div>
                        <div class="form-group col-md-4 mb-0">
                            {{ forms.photo_5|as_crispy_field }}
                            <div style="width: 200px; height: 200px; border:1px solid;display: none;">
                            <img id="image-preview-5" src="#" alt="Image Preview" style="max-width: 200px; height: 100%;display: none;">
                            </div>
                            </div>
                          <div class="form-group col-md-4 mb-0">
                            {{ forms.photo_6|as_crispy_field }}
                              <div style="width: 200px; height: 200px; border:1px solid;display: none;">
                            <img id="image-preview-6" src="#" alt="Image Preview" style="max-width: 200px; height: 100%;display: none;">
                              </div>
                          </div>
                      </div>
		            <table class="table form-table table-bordered table-sm">
                            <thead class="text-center">
                            <tr>
                                <th>Attribute Name</th>
                                <th>Attribute Value</th>
                                <th>Attribute Price</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for form_data in formset %}
                                <tr class="item">
                                    <td class="formset-row">
                                        {{ form_data.a_name }}
                                    </td>
                                       <td class="formset-row">
                                           <select id="id_a_value_{{ form_data.prefix }}" name="{{ form_data.prefix }}-{{form_data.a_value.name }}" class="form-control formset-field">
                                              <option value="" selected="">---------</option>
                                            </select>
                                    </td>
                                       <td>
                                        {{ form_data.price }}
                                    </td>


                                    <td>
                                        <button type="button" class="btn-danger btn-sm remove-form-row"
                                                id="{{ formset.prefix }}">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="9"
                                    style="border-left: none!important; border-right: none !important; border-bottom: none!important;">
                                    <button type="button" class="btn-sm btn-success add-form-row"
                                            id="{{ formset.prefix }}">
                                       Add
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
            {{ formset.management_form }}


                    <button type="submit" class="btn btn-success"> Submit </button>
                </form>
            </div>

        
</div>
<script>
    function addImagePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);

        input.addEventListener('change', function () {
            const file = this.files[0];

            if (file) {
                const reader = new FileReader();

                reader.addEventListener('load', function () {
                    preview.src = reader.result;
                    preview.style.display = 'block';
                    preview.parentElement.style.display= 'block';
                });

                reader.readAsDataURL(file);
            } else {
                preview.src = '#';
                preview.style.display = 'none';
                preview.parentElement.style.display= 'none';

            }
        });
    }

    addImagePreview('id_photo_1', 'image-preview-1');
    addImagePreview('id_photo_2', 'image-preview-2');
    addImagePreview('id_photo_3', 'image-preview-3');
    addImagePreview('id_photo_4', 'image-preview-4');
    addImagePreview('id_photo_5', 'image-preview-5');
    addImagePreview('id_photo_6', 'image-preview-6');


<!--    ajax to get product attribute value from attribute name -->

const get_attribute_values = (row)=>{

            const aNameSelector = row.querySelector('.formset-row select[name$="-a_name"]');
            const aValueSelector = row.querySelector('.formset-row select[name$="-a_value"]');

                const aNameId = aNameSelector.value;
                if (aNameId != ''){
                fetch(`/staff/get_attribute_values/?a_name_id=${aNameId}`)
                    .then(response => response.json())
                    .then(data => {
                        aValueSelector.innerHTML = '<option value="" selected>---------</option>';
                        data.values.forEach(value => {
                            aValueSelector.innerHTML += `<option value="${value.id}">${value.value}</option>`;
                        });
                    });
                }
}

// Use event delegation to attach event listeners to dynamically added forms
document.addEventListener('change', event => {
    const target = event.target;
    if (target && target.parentElement.classList.contains('formset-row') && target.tagName === 'SELECT' && target.name.endsWith('-a_name')) {
        // Assuming 'formset-row' is the class of your form rows
        get_attribute_values(target.parentElement.parentElement);
    }
});

</script>
 <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
    <script src="{% static 'js/formset.js' %}"></script>
{% endblock main-content %}

